---
title: "Michigan COVID-19 Mapping"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: yeti
    # runtime: shiny
    # css: styles.css
    # output: html_document
    
---
```{r setup, include=FALSE}

library(ggplot2)
library(plotly)
library(plyr)
library(readr)
library(deSolve)
library(flexdashboard)
library (shiny)

load('Workspace2020-04-25-1587832621.RData')


# Convert times to date format for convenience
dates = startdate + ftimes
casedates = startdate + times

lastdate = tail(casedates,1)

# Turn off scientific notation on all axes (set scipen to 0 to enable scientific notation)
options(scipen=999)

# Convert dates from ggplot numeric to plotly numeric
dt = function(dates){as.numeric(as.POSIXct(dates))*1000}
```


```{r calcs, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE }

#Calculate bounds
index= likesample<quantile(likesample,0.95)
ymin = apply(yobsincsample[,index], 1, min)
ymax = apply(yobsincsample[,index], 1, max)
ymed = apply(yobsincsample[,index], 1, median)
deathmin = apply(yobsdeathsample[,index], 1, min)
deathmax = apply(yobsdeathsample[,index], 1, max)
deathmed = apply(yobsdeathsample[,index], 1, median)
ICUmin = apply(ycurrICUsample[,index], 1, min)
ICUmax = apply(ycurrICUsample[,index], 1, max)
ICUmed = apply(ycurrICUsample[,index], 1, median)
O2min = apply(ycurrO2sample[,index], 1, min)
O2max = apply(ycurrO2sample[,index], 1, max)
O2med = apply(ycurrO2sample[,index], 1, median)
patmin = apply(ycurrpatsample[,index], 1, min)
patmax = apply(ycurrpatsample[,index], 1, max)
patmed = apply(ycurrpatsample[,index], 1, median)
ventmin = apply(ycurrventsample[,index], 1, min)
ventmax = apply(ycurrventsample[,index], 1, max)
ventmed = apply(ycurrventsample[,index], 1, median)

#Something seems off about this line, at least when I check it, the browser says there's an issue at tx0
xestlh = ode(x0(paramestslh), ftimes, CoVode, paramestslh)

```



Cumulative Cases {data-navmenu="Explorables" data-orientation=rows} 
===================================== 

Sidebar {.sidebar}
-----------------------------------------------------------------------
<a href="#"> Michigan Data </a>

<a href="#"> University of Michigan Data </a>
    

Row
-----------------------------------------------------------------------

### One Week Forecast of COVID-19 Cases in Michigan

<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r forecastplot1wk }

```

### Three Week Forecast of COVID-19 Cases in Michigan 
<!-- <iframe></iframe> -->
```{r forecastplot3wk}

```


Row
-----------------------------------------------------------------------


### Current Summary

Model forecast for cumulative lab-confirmed cases:

```{r forecasttable}
forecasttable = c()
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+7, "%B %e"),'(1 week)'),
                      format(round_any(ymin[(lastdate + 7) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 7) - startdate + 1],1), scientific=F) ) )
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+21, "%B %e"),'(3 weeks)'),
                      format(round_any(ymin[(lastdate + 21) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 21) - startdate + 1],1), scientific=F) ) )
forecasttable = as.data.frame(forecasttable)

colnames(forecasttable) = c("Date", "Uncertainty lower bound", "Best-fit", "Uncertainty upper bound")
knitr::kable(forecasttable)
```

Additionally, the current best fit across model simulations projects (for uncertainty ranges, please see plots):

- `r format(lastdate+7, "%B %e, %Y")` (1 week): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],10)` in ICU
- `r format(lastdate+21, "%B %e, %Y")` (3 weeks): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],10)` in ICU

<p style="font-size: 10pt; font-style: oblique"> Note that the model is a work in progress and being updated as the epidemic progresses. Because we are still making improvements and including new data in the model, these results are highly preliminary and uncertain. The forecasts shown here also do not account for the ongoing changes in social distancing occurring over the coming weeks. For more on social distancing, see the 'Scenarios' tab.</p>

<p style="font-size: 10pt"> For more information about the transmission model and methods, please see the 'About' tab.</p>


<p style="font-size: 10pt">Data is shown as circles and grey shaded regions indicate uncertainty bounds for the best fit 95% across 1000 simulations. Hover over plots to see data values and interactive menu, and scroll down to see additional plots.</p>

*Updated `r format(Sys.time(), "%B %e, %Y at %H:%M %Z")`*

Cumulative Deaths {data-navmenu="Explorables" data-orientation=rows}  
===================================== 
Sidebar {.sidebar}
-----------------------------------------------------------------------
<a href="#"> Michigan Data </a>

<a href="#"> University of Michigan Data </a>

Row
-----------------------------------------------------------------------


### One Week Forecast of COVID-19 Deaths in Michigan

<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r}
  
```

### Three Week Forecast of COVID-19 Deaths in Michigan
<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r}

```



Row
-----------------------------------------------------------------------


### Current Summary

Model forecast for cumulative lab-confirmed cases:

```{r forecasttable2}
forecasttable = c()
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+7, "%B %e"),'(1 week)'),
                      format(round_any(ymin[(lastdate + 7) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 7) - startdate + 1],1), scientific=F) ) )
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+21, "%B %e"),'(3 weeks)'),
                      format(round_any(ymin[(lastdate + 21) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 21) - startdate + 1],1), scientific=F) ) )
forecasttable = as.data.frame(forecasttable)

colnames(forecasttable) = c("Date", "Uncertainty lower bound", "Best-fit", "Uncertainty upper bound")
knitr::kable(forecasttable)
```

Additionally, the current best fit across model simulations projects (for uncertainty ranges, please see plots):

- `r format(lastdate+7, "%B %e, %Y")` (1 week): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],10)` in ICU
- `r format(lastdate+21, "%B %e, %Y")` (3 weeks): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],10)` in ICU

<p style="font-size: 10pt; font-style: oblique"> Note that the model is a work in progress and being updated as the epidemic progresses. Because we are still making improvements and including new data in the model, these results are highly preliminary and uncertain. The forecasts shown here also do not account for the ongoing changes in social distancing occurring over the coming weeks. For more on social distancing, see the 'Scenarios' tab.</p>

<p style="font-size: 10pt"> For more information about the transmission model and methods, please see the 'About' tab.</p>


<p style="font-size: 10pt">Data is shown as circles and grey shaded regions indicate uncertainty bounds for the best fit 95% across 1000 simulations. Hover over plots to see data values and interactive menu, and scroll down to see additional plots.</p>

*Updated `r format(Sys.time(), "%B %e, %Y at %H:%M %Z")`*


    
Hospital and ICU Occupancy {data-navmenu="Explorables" data-orientation=rows} 
===================================== 
Sidebar {.sidebar}
-----------------------------------------------------------------------
<a href="#"> Michigan Data </a>

<a href="#"> University of Michigan Data </a>

Row
-----------------------------------------------------------------------


### Three Week Forecast of COVID-19 Hospital Occupancy in Michigan

<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r}
  
```

### Three Week Forecast of COVID-19 ICU Occupancy in Michigan
<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r}
  
```



Row
-----------------------------------------------------------------------


### Current Summary

Model forecast for cumulative lab-confirmed cases:

```{r forecasttable3}
forecasttable = c()
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+7, "%B %e"),'(1 week)'),
                      format(round_any(ymin[(lastdate + 7) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 7) - startdate + 1],1), scientific=F) ) )
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+21, "%B %e"),'(3 weeks)'),
                      format(round_any(ymin[(lastdate + 21) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 21) - startdate + 1],1), scientific=F) ) )
forecasttable = as.data.frame(forecasttable)

colnames(forecasttable) = c("Date", "Uncertainty lower bound", "Best-fit", "Uncertainty upper bound")
knitr::kable(forecasttable)
```

Additionally, the current best fit across model simulations projects (for uncertainty ranges, please see plots):

- `r format(lastdate+7, "%B %e, %Y")` (1 week): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],10)` in ICU
- `r format(lastdate+21, "%B %e, %Y")` (3 weeks): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],10)` in ICU

<p style="font-size: 10pt; font-style: oblique"> Note that the model is a work in progress and being updated as the epidemic progresses. Because we are still making improvements and including new data in the model, these results are highly preliminary and uncertain. The forecasts shown here also do not account for the ongoing changes in social distancing occurring over the coming weeks. For more on social distancing, see the 'Scenarios' tab.</p>

<p style="font-size: 10pt"> For more information about the transmission model and methods, please see the 'About' tab.</p>


<p style="font-size: 10pt">Data is shown as circles and grey shaded regions indicate uncertainty bounds for the best fit 95% across 1000 simulations. Hover over plots to see data values and interactive menu, and scroll down to see additional plots.</p>

*Updated `r format(Sys.time(), "%B %e, %Y at %H:%M %Z")`*

    
Ventilator and Oxygen Support {data-navmenu="Explorables" data-orientation=rows} 
===================================== 
Sidebar {.sidebar}
-----------------------------------------------------------------------
<a href="#"> Michigan Data </a>

<a href="#"> University of Michigan Data </a>

Row
-----------------------------------------------------------------------


### One Week Forecast of COVID-19 Ventilator Support in Michigan

<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r}
  
```

### Three Week Forecast of COVID-19 Oxygen Support in Michigan
<!-- i added an iframe element here just in case i can get this graphic on shiny instead -->
<!-- <iframe></iframe> -->
```{r}
  
```



Row
-----------------------------------------------------------------------


### Current Summary

Model forecast for cumulative lab-confirmed cases:

```{r forecasttable4}
forecasttable = c()
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+7, "%B %e"),'(1 week)'),
                      format(round_any(ymin[(lastdate + 7) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 7) - startdate + 1],1), scientific=F) ) )
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+21, "%B %e"),'(3 weeks)'),
                      format(round_any(ymin[(lastdate + 21) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 21) - startdate + 1],1), scientific=F) ) )
forecasttable = as.data.frame(forecasttable)

colnames(forecasttable) = c("Date", "Uncertainty lower bound", "Best-fit", "Uncertainty upper bound")
knitr::kable(forecasttable)
```

Additionally, the current best fit across model simulations projects (for uncertainty ranges, please see plots):

- `r format(lastdate+7, "%B %e, %Y")` (1 week): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],10)` in ICU
- `r format(lastdate+21, "%B %e, %Y")` (3 weeks): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],10)` in ICU

<p style="font-size: 10pt; font-style: oblique"> Note that the model is a work in progress and being updated as the epidemic progresses. Because we are still making improvements and including new data in the model, these results are highly preliminary and uncertain. The forecasts shown here also do not account for the ongoing changes in social distancing occurring over the coming weeks. For more on social distancing, see the 'Scenarios' tab.</p>

<p style="font-size: 10pt"> For more information about the transmission model and methods, please see the 'About' tab.</p>


<p style="font-size: 10pt">Data is shown as circles and grey shaded regions indicate uncertainty bounds for the best fit 95% across 1000 simulations. Hover over plots to see data values and interactive menu, and scroll down to see additional plots.</p>

*Updated `r format(Sys.time(), "%B %e, %Y at %H:%M %Z")`*


Social Distancing Scenarios {data-navmenu="Explorables" data-orientation=rows} 
===================================== 


Row { data-height = 850 }
-----------------------------------------------------------------------


### Social Distancing Scenarios 

```{r}
# I really want to do something like below for the rest of the models
```

<iframe id="socialdistancing" src="https://sph-umich.shinyapps.io/covid-19-scenarios/" style="border: none; width: 100%; height: 700px" frameborder="0"></iframe>


About 
===================================== 

Column
-----------------------------------------------------------------------

Model description is in-progress, to be updated soon!

### Overview

This transmission model has been developed to assist in understanding and forecasting epidemic spread and hospital resource needs, and to explore and examine alternative scenarios (see scenarios tab). The model is calibrated based on Michigan data on COVID-19 testing and demographics, as well as Michigan and other literature data on disease progression, severity, mortality, etc. 
<br>

### Model description

<div style="float: right; padding: 15px; width: 450px; font-size:10pt;"><img src="model_diagram_3_29.jpeg" width=100%><br>Figure 1. Diagram for the basic transmission model used in this analysis.</div>
<!-- ![Model diagram](model_diagram_3_24.jpg){#id .class width=50% height=50%} -->

The spread of infectious disease in a population can be modeled as a dynamical system, where the number of infections changes over time accordingly to a host of complex and interrelated processes.  The two fundamental disease processes are transmission and recovery, but sociobehavioral processes or other aspects of the natural history of infection can also be included to model a specific disease outbreak.

We have tested several different models based on more complex versions of what is known as an SIR model, or susceptible (S), infectious (I), recovered (R) model. This class of models tracks the fraction of the population in different disease stages. 

A diagram of the simplest form of our model is shown in Figure 1. In this model of COVID19 disease, we track people who are susceptible ($S$), have mild disease but have not sought care ($I_1$), have mild disease and have sought care ($I_{1,c}$), have recovered ($R$), have severe disease ($I_2$), have been hospitalized ($H$), and have died ($D$). We have also tested similar models accounting for superspreading, alternative distributions of the latent and infectious period, and asymptomatic transmission, with similar results, so we opted for the simplest version of the model in this analysis. From the model, we estimated the number of people who need intensive care, ventilators, or oxygen support as a fraction of hospitalized patients. 

### Uncertainty and limitations

(In progress---more details to be added soon.)

Current Model Limitations

- **Tested fraction of cases**: For any disease, most surveillence data detects only a fraction of the true total cases. For this outbreak, this fraction is changing over time as testing capacity ramps up. For now, we are estimating an average fraction of cases reported. Our predictions will be highly uncertain early in the outbreak before testing capacity and the reporting fraction stabilize.

- **Prediction during the exponential growth phase of an epidemic**: It is notoriously difficult to predict important quantities such as the time or size of the peak number of cases while early on in an outbreak---or even just to forecast more than a couple weeks ahead with any accuracy. For example, we won't know how much social distancing is impacting transmission rates until we start to see a change in the trajectory of cases (which, given the ramp up in testing and relatively long incubation period for this disease, may take days up to a couple of weeks after social distancing changes happen). 

<!-- Additional model assumptions and limitations discussion to add -->

<!-- - Current limitations that will be addressed by coming changes to the model (e.g. fitting to daily incidence rather than cumulative, etc.) -->
<!-- - Limitations that will improve with more data  -->
<!-- - General limitations that (at least for now...) are sort of built in -->
<!-- - Data sources -->
<!-- - Model validation - figures for testing our forecasts against previous data here -->


### Parameter estimation

COVID19 disease is caused by the novel coronavirus SARS-Cov-2. Because it is so new, there is a lot of uncertainty about the natural history of the virus---how long the incubation period is, what the mortality rate is for different age groups, etc. This uncertainty surrounds almost every parameter in our model, and these parameters cannot be estimated from the epidemic curve alone (particularly early in the epidemic when few parameters are needed to replicate the epidemic growth rate).

Because we can make reasonable guesses as to sensible bounds for each parameter, we can take hundreds and thousands of combinations of reasonable values of the model parameters (currently, we use [Sobol sampling](https://arxiv.org/abs/1505.02350)). For each of these combination of parameters, we estimate the value of the reporting rates for cases and deaths that best explain the trajectory of the data. Altogether, these thousands of trajectories represent our best guess as to what the true epidemic curve has been---and what it will be shortly. 


### Parameter values and ranges for sampling
(To be updated with sources)
```{r table}
paramtable = P[c(1,4:23,25),c(1:4,6,7)]
# paramtable[1,5] = "Total population of Michigan"
# paramtable[2,5] = "Fraction of symptomatic individuals who are laboratory-confirmed"
# paramtable[7,5] = "Mortality fraction among infected individuals"
knitr::kable(paramtable)
```


Team
========================================================================================

Column
-----------------------------------------------------------------------

### The Team
The University of Michigan Epimath COVID-19 Modeling group is comprised of:

- Andrew Brouwer, PhD - Department of Epidemiology, University of Michigan
- Sandro Cinti, MD - Department of Internal Medicine, University of Michigan Medical School
- Jeremy D'Silva, Department of Mathematics, University of Michigan
- Peter DeJonge, Department of Epidemiology, University of Michigan
- Marisa Eisenberg, PhD - Departments of Epidemiology and Complex Systems, University of Michigan
- Emily Martin, PhD, MPH - Department of Epidemiology, University of Michigan
- Josh Petrie, PhD, MPH - Department of Epidemiology, University of Michigan
- Marissa Renardy, PhD - Department of Microbiology and Immunology, University of Michigan

Questions? Please contact Marisa Eisenberg (marisae@umich.edu), Andrew Brouwer (brouweaf@umich.edu), and Josh Petrie (jpetrie@umich.edu) for more information.
