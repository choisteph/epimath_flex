---
title: "Michigan COVID-19 Mapping"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: yeti
    navbar:
      - {title: explorables, align: right}
      - {title: reports, align: right}
      - {title: publciations, align: right}
      - {title: about us, align: right}
    runtime: shiny
    
---

```{r setup, include=FALSE}

library(ggplot2)
library(plotly)
library(plyr)
library(readr)
library(deSolve)

library(flexdashboard)
library (shiny)

load('Workspace2020-04-25-1587832621.RData')

# Convert times to date format for convenience
dates = startdate + ftimes
casedates = startdate + times

lastdate = tail(casedates, 1)

# Turn off scientific notation on all axes (scipen = 0 turns it back on)
options(scipen=99)

# Convert dates from ggplot numeric to plotly numeric
dt = function(dates){as.numeric(as.POSIXct(dates)*1000)}

```

Inputs {.sidebar}
-----------------------------------------------------------------------

<a href="#"> Michigan Data </a>

<a href="#"> University of Michigan Data </a>


Row {data-height=300}
-----------------------------------------------------------------------

### One Week Forecast of COVID-19 Cases in Michigan

```{r}


```

### Three Week Forecast of COVID-19 Cases in Michigan

```{r}

```

Row {data-height=500}
-----------------------------------------------------------------------


### Summary

*Updated `r format(Sys.time(), "%B %e, %Y at %H:%M %Z")`*

```{r calcs, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE}
#Calculate bounds
index= likesample<quantile(likesample,0.95)
ymin = apply(yobsincsample[,index], 1, min)
ymax = apply(yobsincsample[,index], 1, max)
ymed = apply(yobsincsample[,index], 1, median)
deathmin = apply(yobsdeathsample[,index], 1, min)
deathmax = apply(yobsdeathsample[,index], 1, max)
deathmed = apply(yobsdeathsample[,index], 1, median)
ICUmin = apply(ycurrICUsample[,index], 1, min)
ICUmax = apply(ycurrICUsample[,index], 1, max)
ICUmed = apply(ycurrICUsample[,index], 1, median)
O2min = apply(ycurrO2sample[,index], 1, min)
O2max = apply(ycurrO2sample[,index], 1, max)
O2med = apply(ycurrO2sample[,index], 1, median)
patmin = apply(ycurrpatsample[,index], 1, min)
patmax = apply(ycurrpatsample[,index], 1, max)
patmed = apply(ycurrpatsample[,index], 1, median)
ventmin = apply(ycurrventsample[,index], 1, min)
ventmax = apply(ycurrventsample[,index], 1, max)
ventmed = apply(ycurrventsample[,index], 1, median)

xestlh = ode(x0(paramestslh), ftimes, CoVode, paramestslh)

```

<p style="font-size: 10pt">Data is shown as circles and grey shaded regions indicate uncertainty bounds for the best fit 95% across 1000 simulations. Hover over plots to see data values and interactive menu, and scroll down to see additional plots.</p>

### Forecast

Model forecast for cumulative lab-confirmed case:
```{r forecasttable}
forecasttable = c()
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+7, "%B %e"),'(1 week)'),
                      format(round_any(ymin[(lastdate + 7) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],1), scientific=F),
                      # format(round_any(ymed[(lastdate + 7) - startdate + 1],1), scientific=F),
                      format(round_any(ymax[(lastdate + 7) - startdate + 1],1), scientific=F) ) )
forecasttable = rbind(forecasttable,
                      c(paste(format(lastdate+21, "%B %e"),'(3 weeks)'),
                      format(round_any(ymin[(lastdate + 21) - startdate + 1],1), scientific=F),
                      format(round_any(yobscumcarefun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],1), scientific=F),

                      format(round_any(ymax[(lastdate + 21) - startdate + 1],1), scientific=F) ) )
forecasttable = as.data.frame(forecasttable)

colnames(forecasttable) = c("Date", "Uncertainty lower bound", "Best-fit", "Uncertainty upper bound")
knitr::kable(forecasttable)
```

Additionally, the current best fit across model simulations projects (for uncertainty ranges, please see plots):

- `r format(lastdate+7, "%B %e, %Y")` (1 week): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 7) - startdate + 1],10)` in ICU
- `r format(lastdate+21, "%B %e, %Y")` (3 weeks): roughly `r round_any(ycurrpatfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],100)` COVID+ hospitalized patients (beds needed) with roughly `r round_any(ycurrICUfun(xestlh,paramestslh)[(lastdate + 21) - startdate + 1],10)` in ICU

